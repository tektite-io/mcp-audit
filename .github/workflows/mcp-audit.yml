# MCP Audit - GitHub Action for scanning MCP configurations
# Scans repositories for MCP configs and dependencies
# Reports findings in PR comments and GitHub Security tab

name: MCP Audit

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  mcp-audit:
    name: Scan for MCP Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MCP Audit
        run: |
          pip install -e .

      - name: Run MCP Audit Scan
        id: scan
        run: |
          # Run scan and capture output
          mcp-audit scan --path . --format json --output mcp-results.json || true

          # Check if results file exists
          if [ -f mcp-results.json ]; then
            echo "scan_completed=true" >> $GITHUB_OUTPUT

            # Count MCPs and risks
            TOTAL=$(jq '.total_mcps // 0' mcp-results.json)
            WITH_RISKS=$(jq '[.mcps[] | select(.risk_flags | length > 0)] | length' mcp-results.json)
            HIGH_RISKS=$(jq '[.mcps[] | select(.risk_flags[] | contains("shell-access") or contains("unverified-source"))] | length' mcp-results.json)

            echo "total_mcps=$TOTAL" >> $GITHUB_OUTPUT
            echo "with_risks=$WITH_RISKS" >> $GITHUB_OUTPUT
            echo "high_risks=$HIGH_RISKS" >> $GITHUB_OUTPUT
          else
            echo "scan_completed=false" >> $GITHUB_OUTPUT
            echo "total_mcps=0" >> $GITHUB_OUTPUT
            echo "with_risks=0" >> $GITHUB_OUTPUT
            echo "high_risks=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate SARIF Report
        if: steps.scan.outputs.scan_completed == 'true' && steps.scan.outputs.total_mcps != '0'
        run: |
          python -c "
          import json
          from datetime import datetime

          # Load scan results
          with open('mcp-results.json') as f:
              results = json.load(f)

          # Generate SARIF
          sarif = {
              '\$schema': 'https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json',
              'version': '2.1.0',
              'runs': [{
                  'tool': {
                      'driver': {
                          'name': 'MCP Audit',
                          'version': '0.1.0',
                          'informationUri': 'https://github.com/apisec/mcp-audit',
                          'rules': []
                      }
                  },
                  'results': []
              }]
          }

          # Risk flag severity mapping
          severity_map = {
              'shell-access': 'error',
              'unverified-source': 'error',
              'filesystem-access': 'warning',
              'database-access': 'warning',
              'secrets-in-env': 'warning',
              'network-access': 'note',
              'local-binary': 'warning',
              'dependency-only': 'note'
          }

          rules = {}

          for mcp in results.get('mcps', []):
              for flag in mcp.get('risk_flags', []):
                  if flag not in rules:
                      rules[flag] = {
                          'id': f'mcp-{flag}',
                          'name': flag.replace('-', ' ').title(),
                          'shortDescription': {'text': f'MCP has {flag} capability'},
                          'defaultConfiguration': {
                              'level': severity_map.get(flag, 'note')
                          }
                      }

                  sarif['runs'][0]['results'].append({
                      'ruleId': f'mcp-{flag}',
                      'message': {
                          'text': f'MCP \"{mcp[\"name\"]}\" (source: {mcp[\"source\"]}) has {flag}'
                      },
                      'locations': [{
                          'physicalLocation': {
                              'artifactLocation': {
                                  'uri': mcp.get('config_path', 'unknown')
                              }
                          }
                      }],
                      'level': severity_map.get(flag, 'note')
                  })

          sarif['runs'][0]['tool']['driver']['rules'] = list(rules.values())

          with open('mcp-audit.sarif', 'w') as f:
              json.dump(sarif, f, indent=2)
          "

      - name: Upload SARIF to GitHub Security
        if: steps.scan.outputs.scan_completed == 'true' && steps.scan.outputs.total_mcps != '0'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: mcp-audit.sarif

      - name: Create Job Summary
        run: |
          echo "## MCP Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.scan.outputs.scan_completed }}" == "true" ]; then
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total MCPs Found | ${{ steps.scan.outputs.total_mcps }} |" >> $GITHUB_STEP_SUMMARY
            echo "| MCPs with Risk Flags | ${{ steps.scan.outputs.with_risks }} |" >> $GITHUB_STEP_SUMMARY
            echo "| High-Risk MCPs | ${{ steps.scan.outputs.high_risks }} |" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.scan.outputs.total_mcps }}" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Details" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              cat mcp-results.json >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "No MCP configurations found in this repository." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No MCP configurations found in this repository." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.scan.outputs.scan_completed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const total = '${{ steps.scan.outputs.total_mcps }}';
            const withRisks = '${{ steps.scan.outputs.with_risks }}';
            const highRisks = '${{ steps.scan.outputs.high_risks }}';

            let body = '## MCP Audit Results\n\n';

            if (total === '0') {
              body += '**No MCP configurations found in this PR.**\n';
            } else {
              body += '| Metric | Count |\n';
              body += '|--------|-------|\n';
              body += `| Total MCPs Found | ${total} |\n`;
              body += `| MCPs with Risk Flags | ${withRisks} |\n`;
              body += `| High-Risk MCPs | ${highRisks} |\n\n`;

              if (parseInt(highRisks) > 0) {
                body += '**:warning: High-risk MCPs detected!** Please review before merging.\n';
              }
            }

            body += '\n---\n*Powered by [MCP Audit](https://github.com/apisec/mcp-audit)*';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail on High Risk (configurable)
        if: steps.scan.outputs.high_risks != '0'
        run: |
          echo "::warning::High-risk MCPs detected: ${{ steps.scan.outputs.high_risks }}"
          # Uncomment to fail the build on high-risk MCPs:
          # exit 1
